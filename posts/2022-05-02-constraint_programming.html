<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.326">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Maxime Labonne">
<meta name="dcterms.date" content="2022-05-02">
<meta name="description" content="The Programming Paradigm to Find One Solution Among 8,080,104 Candidates">

<title>Maxime Labonne - Introduction to Constraint Programming in Python</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../images/favicon.ico" rel="icon">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-4DWYJM47PC"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-4DWYJM47PC', { 'anonymize_ip': true});
</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../styles.css">
<meta property="og:title" content="Maxime Labonne - Introduction to Constraint Programming in Python">
<meta property="og:description" content="The Programming Paradigm to Find One Solution Among 8,080,104 Candidates">
<meta property="og:image" content="https://mlabonne.github.io/images/cp/thumbnail.jpg">
<meta property="og:site-name" content="Maxime Labonne">
<meta name="twitter:title" content="Maxime Labonne - Introduction to Constraint Programming in Python">
<meta name="twitter:description" content="The Programming Paradigm to Find One Solution Among 8,080,104 Candidates">
<meta name="twitter:image" content="https://mlabonne.github.io/images/cp/thumbnail.jpg">
<meta name="twitter:creator" content="@maximelabonne">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Maxime Labonne</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../about.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../publications.html" rel="" target="">
 <span class="menu-text">Publications</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../book.html" rel="" target="">
 <span class="menu-text">Book</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/mlabonne" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/maximelabonne" rel="" target=""><i class="bi bi-twitter" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Introduction to Constraint Programming in Python</h1>
                  <div>
        <div class="description">
          The Programming Paradigm to Find One Solution Among 8,080,104 Candidates
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">constraint programming</div>
                <div class="quarto-category">linear programming</div>
                <div class="quarto-category">OR-Tools</div>
                <div class="quarto-category">python</div>
                <div class="quarto-category">tutorial</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Maxime Labonne </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">May 2, 2022</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<center>
<img src="https://mlabonne.github.io/blog/images/cp/thumbnail.jpg">
</center>
<p>Constraint Programming is a technique to <strong>find every solution</strong> that respects a set of predefined constraints.</p>
<p>It is an invaluable tool for data scientists to solve a huge variety of problems, such as scheduling, timetabling, sequencing, etc. In this article, we’ll see how to use CP in two different ways:</p>
<ol type="1">
<li><strong>Satisfiability</strong>: the goal is to find one or multiple feasible solutions (<em>i.e.</em>, solutions that respect our constraints) by narrowing down a large set of potential solutions;</li>
<li><strong>Optimization</strong>: the goal is to find the best feasible solution according to an objective function, just like Linear Programming (LP).</li>
</ol>
<p>We’ll use CP-SAT from <a href="https://developers.google.com/optimization">Google OR-Tools</a>, an excellent free and open source CP solver. Note that it is <strong>different</strong> from MPSolver, which is dedicated to Linear and Mixed Integer Programming. The difference between CP and LP is quite confusing, we’ll touch on this topic at the end of the article.</p>
<p>You can run the code with the following <a href="https://colab.research.google.com/drive/1huTlPTaahdEEO29KKdlW9ic5zAwB3D58?usp=sharing">Google Colab notebook</a>.</p>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>python <span class="op">-</span>m pip install <span class="op">--</span>upgrade <span class="op">--</span>user <span class="op">-</span>q ortools</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="i.-satisfiability-with-the-3-scouts-problem" class="level2">
<h2 class="anchored" data-anchor-id="i.-satisfiability-with-the-3-scouts-problem">🪖 I. Satisfiability with the 3 scouts problem</h2>
<center>
<img src="https://mlabonne.github.io/blog/images/cp/scouts.png" width="800" style="margin-bottom:0px; margin-top:0px;">
</center>
<p>In the <a href="https://towardsdatascience.com/integer-programming-vs-linear-programming-in-python-f1be5bb4e60e">previous article</a>, we created an army to defeat our opponent. But there was one small problem: we had to guess how powerful his army was.</p>
<p>This time, let’s send scouts to know the <strong>exact number</strong>. Our 3 scouts observed the enemy camp, and this is what they tell us:</p>
<ul>
<li><strong>Scout 1</strong>: “<em>the number of soldiers is a multiple of 13</em>”;</li>
<li><strong>Scout 2</strong>: “<em>the number of soldiers is a multiple of 19</em>”;</li>
<li><strong>Scout 3</strong>: “<em>the number of soldiers is a multiple of 37</em>”;</li>
<li>They all agree that the number of soldiers <strong>doesn’t exceed 10,000</strong>.</li>
</ul>
<p>Our scouts have a personal way of counting soldiers, but we can <strong>combine</strong> these three observations to make a model.</p>
<p>Let’s call the number of soldiers <span class="math inline">\(army\)</span>. We can translate our problem into the following congruence system:</p>
<p><span class="math display">\[
    army \equiv 0 \mod 13\\
    army \equiv 0 \mod 19\\
    army \equiv 0 \mod 37
\]</span></p>
<p>If you’re not familiar with this notation, this is what it means in <strong>programming terms</strong>:</p>
<p><span class="math display">\[
    army\ \% \ 13 = 0\\
    army\ \% \ 19 = 0\\
    army\ \% \ 37 = 0
\]</span></p>
<p>Let’s implement it with OR-Tools. The first thing we need to do is to import and create the <strong>CP-SAT model and solver</strong>.</p>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ortools.sat.python <span class="im">import</span> cp_model</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Instantiate model and solver</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> cp_model.CpModel()</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>solver <span class="op">=</span> cp_model.CpSolver()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <strong>modeling process</strong> is very similar to what we did in Linear Programming.</p>
<p>The first step to create our CP model is to declare the <strong>variables</strong>. In this example, we only have one: <span class="math inline">\(army\)</span>, the number of soldiers.</p>
<p>We have to give lower and upper bounds. The <strong>lower bound</strong> is 1 since we know there’s an army, and the <strong>upper bound</strong> is 10,000 according to the scouts:</p>
<p><span class="math display">\[1 \leq army \leq 10\ 000\]</span></p>
<p>In OR-Tools, we use the <code>NewIntVar</code> method to create this variable.</p>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Variable</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>army <span class="op">=</span> model.NewIntVar(<span class="dv">1</span>, <span class="dv">10000</span>, <span class="st">'army'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The second step is to declare the <strong>constraints</strong>.</p>
<p>We identified three constraints in this example. Modulo is a special operator, so we need a specific function to handle it with CP-SAT: <code>AddModuloEquality</code>. You can find a reference guide at <a href="https://developers.google.com/optimization/reference/python/sat/python/cp_model">this address</a> if you need other methods.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Constraints</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co"># variable % mod = target → (target, variable, mod)</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>model.AddModuloEquality(<span class="dv">0</span>, army, <span class="dv">13</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>model.AddModuloEquality(<span class="dv">0</span>, army, <span class="dv">19</span>)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>model.AddModuloEquality(<span class="dv">0</span>, army, <span class="dv">37</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Unlike Linear Programming, we <strong>don’t have to define an objective function</strong> here.</p>
<p>The reason is simple: there is nothing to optimize! We just want to find a <strong>feasible solution</strong> that satisfies our constraints, but there is no “good” or “bad” answers. This is a <strong>key feature</strong> of Constraint Programming.</p>
<p>Our model is <strong>complete</strong>, we can now ask OR-Tools to solve it.</p>
<div class="cell" data-outputid="a2dada7e-cacf-4fcf-e7fc-c856b7adddd4" data-execution_count="5">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Find the variable that satisfies these constraints</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>status <span class="op">=</span> solver.Solve(model)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co"># If a solution has been found, print results</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> status <span class="op">==</span> cp_model.OPTIMAL <span class="kw">or</span> status <span class="op">==</span> cp_model.FEASIBLE:</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'================= Solution ================='</span>)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'Solved in </span><span class="sc">{</span>solver<span class="sc">.</span>WallTime()<span class="sc">:.2f}</span><span class="ss"> milliseconds'</span>)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>()</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'🪖 Army = </span><span class="sc">{</span>solver<span class="sc">.</span>Value(army)<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>()</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'Check solution:'</span>)</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f' - Constraint 1: </span><span class="sc">{</span>solver<span class="sc">.</span>Value(army)<span class="sc">}</span><span class="ss"> % 13 = </span><span class="sc">{</span>solver<span class="sc">.</span>Value(army) <span class="op">%</span> <span class="dv">13</span><span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f' - Constraint 2: </span><span class="sc">{</span>solver<span class="sc">.</span>Value(army)<span class="sc">}</span><span class="ss"> % 19 = </span><span class="sc">{</span>solver<span class="sc">.</span>Value(army) <span class="op">%</span> <span class="dv">19</span><span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f' - Constraint 3: </span><span class="sc">{</span>solver<span class="sc">.</span>Value(army)<span class="sc">}</span><span class="ss"> % 37 = </span><span class="sc">{</span>solver<span class="sc">.</span>Value(army) <span class="op">%</span> <span class="dv">37</span><span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'The solver could not find a solution.'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>================= Solution =================
Solved in 0.01 milliseconds

🪖 Army = 9139

Check solution:
 - Constraint 1: 9139 % 13 = 0
 - Constraint 2: 9139 % 19 = 0
 - Constraint 3: 9139 % 37 = 0</code></pre>
</div>
</div>
<p>We obtained our solution in less than a millisecond: there are <strong>9,139 soldiers</strong> in the enemy army. Huzzah, we can now fire the scouts!</p>
<p>We limited the search space with an upper bound of 10,000, which gave us a <strong>unique solution</strong>. But is it still the case if we push this limit?</p>
<p>Another perk of CP is the ability to <strong>find every possible solution</strong> to a problem. This might take a long time when the search space is large because the solver has to brute force the entire space (instead of reducing it with heuristics). Let’s explore this feature by printing every possible solution with a new upper bound of <strong>100,000</strong>.</p>
<p>With OR-Tools, we ask the solver to look for every possible solution thanks to the <code>enumerate_all_solutions</code> parameter. We then assign it a <strong>callback</strong> class that prints every solution the solver finds.</p>
<div class="cell" data-outputid="00914085-835b-4a24-8f87-3f35481efcc7" data-execution_count="6">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> cp_model.CpModel()</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>solver <span class="op">=</span> cp_model.CpSolver()</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Variable</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>army <span class="op">=</span> model.NewIntVar(<span class="dv">1</span>, <span class="dv">100000</span>, <span class="st">'army'</span>)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Constraints</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>model.AddModuloEquality(<span class="dv">0</span>, army, <span class="dv">13</span>)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>model.AddModuloEquality(<span class="dv">0</span>, army, <span class="dv">19</span>)</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>model.AddModuloEquality(<span class="dv">0</span>, army, <span class="dv">37</span>)</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> PrintSolutions(cp_model.CpSolverSolutionCallback):</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Callback to print every solution."""</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, variable):</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>        cp_model.CpSolverSolutionCallback.<span class="fu">__init__</span>(<span class="va">self</span>)</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.__variable <span class="op">=</span> variable</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> on_solution_callback(<span class="va">self</span>):</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="va">self</span>.Value(<span class="va">self</span>.__variable))</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Solve with callback</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>solution_printer <span class="op">=</span> PrintSolutions(army)</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>solver.parameters.enumerate_all_solutions <span class="op">=</span> <span class="va">True</span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>status <span class="op">=</span> solver.Solve(model, solution_printer)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>9139
18278
27417
36556
45695
54834
63973
73112
82251
91390</code></pre>
</div>
</div>
<p>We found <strong>10 solutions</strong>! This was to be expected since we increased the upper bound tenfold: these solutions all are <strong>multiples</strong> of 9,139.</p>
<p>As you can see, this example has nothing to do with optimization: it’s a pure <strong>satisfiability problem</strong>. On another note, this congruence system can be solved manually with the <a href="https://en.wikipedia.org/wiki/Chinese_remainder_theorem">Chinese remainder theorem</a>. But CP is not limited to that…</p>
</section>
<section id="ii.-optimization-and-beer" class="level2">
<h2 class="anchored" data-anchor-id="ii.-optimization-and-beer">🍻 II. Optimization and beer</h2>
<center>
<img src="https://mlabonne.github.io/blog/images/cp/cart.png" width="500" style="margin-bottom:0px; margin-top:0px;">
</center>
<p>Let’s see another problem: our army will face the enemy in a few days. In the meantime, the quartermaster has to <strong>prepare the rations</strong> that will be used during the campaign.</p>
<p>The space in the supply wagons is <strong>limited</strong> and some rations are more <strong>popular</strong> than others. There are three possible rations:</p>
<ul>
<li>🥖 <strong>Bread</strong>: it takes only 1 space but soldiers don’t like it that much with a popularity of 3;</li>
<li>🥩 <strong>Meat</strong>: it takes 3 spaces and has a popularity of 10;</li>
<li>🍺 <strong>Beer</strong>: it takes 7 spaces but soldiers love it with a popularity of 26.</li>
</ul>
<center>
<img src="https://mlabonne.github.io/blog/images/cp/table.png" width="800">
</center>
<p>The supply wagons have a capacity of <strong>19 spaces</strong>. How to select the best rations to <strong>maximize</strong> the popularity?</p>
<p>This is an <strong>optimization</strong> problem we’ve already seen: actually, it is a variant of the famous <a href="https://en.wikipedia.org/wiki/Knapsack_problem">knapsack problem</a>. We could reuse the code from the previous article and just change the input parameters.</p>
<p>This time, we’ll solve it using Constraint Programming. This paradigm is not limited to finding feasible solutions. It can also perform optimization using <a href="https://en.wikipedia.org/wiki/Constrained_optimization">different algorithms</a> to handle this overhead.</p>
<p>Let’s create a model of the problem. First of all, we have to declare three variables: 🥖<strong>bread</strong>, 🥩<strong>meat</strong>, and 🍺<strong>beer</strong>. It’s possible to have 0 of them, but their number cannot exceed the maximal capacity.</p>
<p><span class="math display">\[0 \leq bread \leq capacity \\
0 \leq meat \leq capacity \\
0 \leq beer \leq capacity\]</span></p>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Instantiate model and solver</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> cp_model.CpModel()</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>solver <span class="op">=</span> cp_model.CpSolver()</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Variables</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>capacity <span class="op">=</span> <span class="dv">19</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>bread <span class="op">=</span> model.NewIntVar(<span class="dv">0</span>, capacity, <span class="st">'bread'</span>)</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>meat  <span class="op">=</span> model.NewIntVar(<span class="dv">0</span>, capacity, <span class="st">'meat'</span>)</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>beer  <span class="op">=</span> model.NewIntVar(<span class="dv">0</span>, capacity, <span class="st">'beer'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This time, we only have one constraint: the space occupied by the bread, the meat, and the beer <strong>cannot exceed the wagons’ capacity</strong> (19).</p>
<p><span class="math display">\[1 \times bread + 3 \times meat + 7 \times beer \leq 19\]</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Constraints</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>model.Add(<span class="dv">1</span> <span class="op">*</span> bread</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>        <span class="op">+</span> <span class="dv">3</span> <span class="op">*</span> meat </span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>        <span class="op">+</span> <span class="dv">7</span> <span class="op">*</span> beer <span class="op">&lt;=</span> capacity)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We want to <strong>maximize the total popularity</strong> of the rations that are selected:</p>
<p><span class="math display">\[max\ 3 \times bread + 10 \times meat + 26 \times beer\]</span></p>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Objective</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>model.Maximize(<span class="dv">3</span>  <span class="op">*</span> bread</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>             <span class="op">+</span> <span class="dv">10</span> <span class="op">*</span> meat</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>             <span class="op">+</span> <span class="dv">26</span> <span class="op">*</span> beer)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The model is complete, CP-SAT can <strong>solve the problem</strong>!</p>
<div class="cell" data-outputid="f911d90a-1032-4e8d-b6b5-a371265d475c" data-execution_count="11">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Solve problem</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>status <span class="op">=</span> solver.Solve(model)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co"># If an optimal solution has been found, print results</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> status <span class="op">==</span> cp_model.OPTIMAL:</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'================= Solution ================='</span>)</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'Solved in </span><span class="sc">{</span>solver<span class="sc">.</span>WallTime()<span class="sc">:.2f}</span><span class="ss"> milliseconds'</span>)</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>()</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'Optimal value = </span><span class="sc">{</span><span class="dv">3</span><span class="op">*</span>solver<span class="sc">.</span>Value(bread)<span class="op">+</span><span class="dv">10</span><span class="op">*</span>solver<span class="sc">.</span>Value(meat)<span class="op">+</span><span class="dv">26</span><span class="op">*</span>solver<span class="sc">.</span>Value(beer)<span class="sc">}</span><span class="ss"> popularity'</span>)</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'Food:'</span>)</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f' - 🥖Bread = </span><span class="sc">{</span>solver<span class="sc">.</span>Value(bread)<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f' - 🥩Meat  = </span><span class="sc">{</span>solver<span class="sc">.</span>Value(meat)<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f' - 🍺Beer  = </span><span class="sc">{</span>solver<span class="sc">.</span>Value(beer)<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'The solver could not find an optimal solution.'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>================= Solution =================
Solved in 0.01 milliseconds

Optimal value = 68 popularity
Food:
 - 🥖Bread = 2
 - 🥩Meat  = 1
 - 🍺Beer  = 2</code></pre>
</div>
</div>
<p>We obtained the <strong>highest popularity</strong> (68) possible with a capacity of 19.</p>
<p>Is the constraint respected? Let’s quickly check it: 1×2🥖 + 3×1🥩 + 7×2🍺 = 19, which is indeed ≤ 19.</p>
<p>Okay, I’d like to ask another question: <strong>how many solutions</strong> to this problem are there? Once again, we can answer it with a specific callback to count them.</p>
<div class="cell" data-outputid="5641b18a-1086-4e0f-ced3-3fca045a5737" data-execution_count="12">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CountSolutions(cp_model.CpSolverSolutionCallback):</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Count the number of solutions."""</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>        cp_model.CpSolverSolutionCallback.<span class="fu">__init__</span>(<span class="va">self</span>)</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.__solution_count <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> on_solution_callback(<span class="va">self</span>):</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.__solution_count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> solution_count(<span class="va">self</span>):</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.__solution_count</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>solution_printer <span class="op">=</span> CountSolutions()</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Instantiate model and solver</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> cp_model.CpModel()</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>solver <span class="op">=</span> cp_model.CpSolver()</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Variables</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>capacity <span class="op">=</span> <span class="dv">19</span></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>bread <span class="op">=</span> model.NewIntVar(<span class="dv">0</span>, capacity, <span class="st">'Bread'</span>)</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>meat  <span class="op">=</span> model.NewIntVar(<span class="dv">0</span>, capacity, <span class="st">'Meat'</span>)</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>beer  <span class="op">=</span> model.NewIntVar(<span class="dv">0</span>, capacity, <span class="st">'Beer'</span>)</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Constraints</span></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>model.Add(<span class="dv">1</span> <span class="op">*</span> bread</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>        <span class="op">+</span> <span class="dv">3</span> <span class="op">*</span> meat </span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>        <span class="op">+</span> <span class="dv">7</span> <span class="op">*</span> beer <span class="op">&lt;=</span> capacity)</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Print results</span></span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>solver.parameters.enumerate_all_solutions <span class="op">=</span> <span class="va">True</span></span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>status <span class="op">=</span> solver.Solve(model, solution_printer)</span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(solution_printer.solution_count())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>121</code></pre>
</div>
</div>
<p>We found <strong>121 solutions</strong> with a capacity of 19. But this number quickly increases: with a capacity of 1000, there are <strong>8,080,104</strong> possible solutions! And yet, CP-SAT finds the optimal solution in less than a second. How is it possible?</p>
<p>CP solvers do not brute force the problem with an exhaustive search, but combine heuristics and combinatorial search instead. More specifically, the three most popular techniques for constraint satisfaction problems are <a href="https://en.wikipedia.org/wiki/Backtracking"><strong>backtracking</strong></a>, <a href="https://en.wikipedia.org/wiki/Local_consistency"><strong>constraint propagation</strong></a>, and <a href="https://en.wikipedia.org/wiki/Local_search_(optimization)"><strong>local search</strong></a>.</p>
<p>CP-SAT is quite particular since it combines CP and <a href="https://en.wikipedia.org/wiki/Boolean_satisfiability_problem"><strong>SAT</strong></a>: it is part of a broader trend of merging CP, LP, SAT, and metaheuristics.</p>
<p>We said that the previous problem could be solved with Linear Programming, so let’s compare the code of both solutions:</p>
<center>
<img src="https://mlabonne.github.io/blog/images/cp/code.png">
</center>
<p>As you can see, the syntax is quite similar but it’s not the same: model/solver vs.&nbsp;solver, <code>NewIntVar</code> instead of <code>IntVar</code>, etc. There’s a bit of translation to do, but it’s easily manageable.</p>
<p>These two techniques are <strong>incredibly close to each other</strong>: they both handle variables with constraints and perform optimization using math and heuristics. However, CP is limited to discrete parameters, while LP handles continuous ones. On the other hand, you can implement specialized constraints like <a href="https://www.ibm.com/docs/en/icos/12.9.0?topic=variables-all-different-constraint">“all different”</a> in CP, but not in LP. Here is a summary of the main differences between these two technologies:</p>
<center>
<img src="https://mlabonne.github.io/blog/images/cp/comparison.png" width="800">
</center>
<p>If you want to know more about this topic, I would recommend <a href="https://pubsonline.informs.org/doi/abs/10.1287/inte.31.6.29.9647">this article</a> by Irvin J. Lustig and Jean-François Puget. CPLEX’s documentation also details the differences <a href="http://ibmdecisionoptimization.github.io/docplex-doc/mp_vs_cp.html">at this address</a>, in terms of modeling and optimization.</p>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<center>
<img src="https://mlabonne.github.io/blog/images/cp/infographic.png" width="600">
</center>
<p>Constraint Programming is another incredible technique in the <strong>mathematical optimization</strong> toolbox. It is a radically different approach compared to traditional, declarative programming. In this article,</p>
<ul>
<li>We saw <strong>two applications</strong> of CP with satisfiability and optimization;</li>
<li>We implemented <strong>CP models</strong> in OR-Tools and played with the callback function;</li>
<li>We highlighted the <strong>differences</strong> between CP and LP.</li>
</ul>
<p>We limited ourselves to simple problems in this introduction, but CP has amazing applications in complex scheduling and routing problems. This is a topic I’d love to address in a future article.</p>
<p>If you’re interested to know more about it, feel free to follow me on <strong>Twitter</strong> <a href="https://twitter.com/maximelabonne"><span class="citation" data-cites="maximelabonne">@maximelabonne</span></a>. Thanks for your attention!</p>
</section>
<section id="linear-programming-course" class="level2">
<h2 class="anchored" data-anchor-id="linear-programming-course">🥇 Linear Programming Course</h2>
<p><a href="https://github.com/mlabonne/Linear-Programming-Course" class="related">🔎 Course overview</a></p>
<p><a href="https://mlabonne.github.io/blog/linearoptimization/" class="related">📝 Chapter 1: Introduction to Linear Programming</a></p>
<p><a href="https://mlabonne.github.io/blog/integerprogramming/" class="related">📝 Chapter 2: Integer vs.&nbsp;Linear Programming</a></p>
<p><a href="https://mlabonne.github.io/blog/constraintprogramming/" class="related">📝 Chapter 3: Constraint Programming</a></p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>